<div id="particle-canvas-container"></div>

<script>
    // =======================================================
    // == GLOBAL PARAMETERS TO TWEAK THE ANIMATION ==
    // =======================================================
    const PARTICLE_COUNT = 300;
    const MAX_SPEED = 1.5;
    const TURBULENCE = 2 * Math.PI * 2;
    // How chaotic the flow is
    const FIELD_MAGNITUDE = 0.1;
    // How strongly particles follow the flow

    // --- COLOR SETTINGS ---
    const PARTICLE_ALPHA = 40;
    // Opacity of particle trails (0-255)
    const RGB_LOW = 30;
    // Low end for random color channels (0-255)
    const RGB_HIGH = 255;
    // High end for random color channels (0-255)
    const BACKGROUND_RGB = [239, 241, 245];
    // Your --base00 color
	const TRAIL_LENGTH = 300; // Number of previous positions to remember
// Get CSS variables from :root
const rootStyles = getComputedStyle(document.documentElement);

// Collect the base08â€“base0F colors into an array
const palette = [
  rootStyles.getPropertyValue("--base08").trim(),
  rootStyles.getPropertyValue("--base09").trim(),
  rootStyles.getPropertyValue("--base0A").trim(),
  rootStyles.getPropertyValue("--base0B").trim(),
  rootStyles.getPropertyValue("--base0C").trim(),
  rootStyles.getPropertyValue("--base0D").trim(),
  rootStyles.getPropertyValue("--base0E").trim(),
  rootStyles.getPropertyValue("--base0F").trim(),
];


// Convert to rgba with alpha if you want the same style as before
function hexToRgba(hex, alpha = 1.0) {
  const bigint = parseInt(hex.slice(1), 16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  return [r, g, b, alpha];
}

    // =======================================================

    class Particle {
        constructor(p) {
            this.p = p;
            this.pos = p.createVector(p.random(p.width), p.random(p.height));
            this.vel = p.createVector(0, 0);
            this.acc = p.createVector(0, 0);
            this.maxSpeed = MAX_SPEED;
// Pick one at random
const randomHex = palette[Math.floor(Math.random() * palette.length)];
this.color = hexToRgba(randomHex, PARTICLE_ALPHA);
			this.trail = [];
        }

        update() {
			this.trail.push(this.pos.copy());
			if (this.trail.length > TRAIL_LENGTH) {
				this.trail.shift();
			}
            this.vel.add(this.acc);
            this.vel.limit(this.maxSpeed);
            this.pos.add(this.vel);
            this.acc.mult(0);
        }


        applyForce(force) {
            this.acc.add(force);
        }

        show() {
            this.p.stroke(this.color);
            this.p.strokeWeight(1);
			for (let i = 0; i < this.trail.length - 1; i++) {
				const x1 = this.trail[i].x;
				const y1 = this.trail[i].y;
				const x2 = this.trail[i + 1].x;
				const y2 = this.trail[i + 1].y;
				const alpha = this.p.map(
                        i,
                        0,
                        this.trail.length - 1,
                        5,
                        PARTICLE_ALPHA,
                    );

                    this.p.stroke(
                        this.color[0],
                        this.color[1],
                        this.color[2],
                        alpha,
                    );

                    this.p.line(x1, y1, x2, y2); 
			}
        }

        edges() {
            if (this.pos.x > this.p.width) {
                this.pos.x = 0;
				this.trail = [];
            }
            if (this.pos.x < 0) {
                this.pos.x = this.p.width;
				this.trail = [];
            }
            if (this.pos.y > this.p.height) {
                this.pos.y = 0;
				this.trail = [];
            }
            if (this.pos.y < 0) {
                this.pos.y = this.p.height;
				this.trail = [];
            }
        }

        follow(flowfield) {
            const x = Math.floor(this.pos.x / 20);
            const y = Math.floor(this.pos.y / 20);
            const index = x + y * Math.floor(this.p.width / 20);
            const force = flowfield[index];
            if (force) {
                this.applyForce(force);
            }
        }
    }

    const sketch = (p) => {
        let particles = [];
        let flowfield;

        p.setup = () => {
// Select the container div
    const canvasContainer = p.select('#particle-canvas-container');

    // Get its width and height, which are set by the CSS
    const w = canvasContainer.width;
    const h = canvasContainer.height;

    // Create the canvas with those dimensions
    const canvas = p.createCanvas(w, h);

    // Tell the canvas to live inside that container
    canvas.parent('particle-canvas-container');

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                particles[i] = new Particle(p);
            }
            p.background(BACKGROUND_RGB);
        };
        p.draw = () => {
p.background(
                BACKGROUND_RGB[0],
                BACKGROUND_RGB[1],
                BACKGROUND_RGB[2],
            );
            const cols = Math.floor(p.width / 20);
            const rows = Math.floor(p.height / 20);
            flowfield = new Array(cols * rows);
            let yoff = 0;
            for (let y = 0; y < rows; y++) {
                let xoff = 0;
                for (let x = 0; x < cols; x++) {
                    const index = x + y * cols;
                    const angle =
                        p.noise(xoff, yoff, p.frameCount * 0.0005) * TURBULENCE;
                    const v = p5.Vector.fromAngle(angle);
                    v.setMag(FIELD_MAGNITUDE);
                    flowfield[index] = v;
                    xoff += 0.1;
                }
                yoff += 0.1;
            }

            for (let i = 0; i < particles.length; i++) {
                particles[i].follow(flowfield);
                particles[i].update();
                particles[i].show();
                particles[i].edges();
            }
        };

    };

    document.addEventListener("DOMContentLoaded", () => {
        if (window.p5) {
            new window.p5(sketch);
        }
    });
</script>

<style>
    #particle-canvas-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: calc(100% - 80px);
        z-index: -1;
    }
</style>
